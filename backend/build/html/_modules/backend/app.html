<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>backend.app &#8212; Policy Pal  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=27fed22d" />
    <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for backend.app</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Flask Application for Backend Management</span>

<span class="sd">This module provides a Flask application that supports user registration,</span>
<span class="sd">login, bill storage, and scraping/updating congressional bill details.</span>
<span class="sd">It uses Flask-SQLAlchemy for database operations, Flask CLI for command line commands,</span>
<span class="sd">and includes secure password handling.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">timezone</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">bs4</span><span class="w"> </span><span class="kn">import</span> <span class="n">BeautifulSoup</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">openai</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">click</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">jsonify</span><span class="p">,</span> <span class="n">request</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask_sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">SQLAlchemy</span>  
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">or_</span><span class="p">,</span> <span class="n">text</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.ext.mutable</span><span class="w"> </span><span class="kn">import</span> <span class="n">MutableDict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask_cors</span><span class="w"> </span><span class="kn">import</span> <span class="n">CORS</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask.cli</span><span class="w"> </span><span class="kn">import</span> <span class="n">with_appcontext</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask_jwt_extended</span><span class="w"> </span><span class="kn">import</span> <span class="n">JWTManager</span><span class="p">,</span> <span class="n">create_access_token</span><span class="p">,</span> <span class="n">jwt_required</span><span class="p">,</span> <span class="n">get_jwt_identity</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">dotenv</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_dotenv</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">apscheduler.schedulers.background</span><span class="w"> </span><span class="kn">import</span> <span class="n">BackgroundScheduler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">werkzeug.security</span><span class="w"> </span><span class="kn">import</span> <span class="n">generate_password_hash</span><span class="p">,</span> <span class="n">check_password_hash</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.feature_extraction.text</span><span class="w"> </span><span class="kn">import</span> <span class="n">TfidfVectorizer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics.pairwise</span><span class="w"> </span><span class="kn">import</span> <span class="n">cosine_similarity</span>

<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="c1"># Application and Configuration</span>
<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">CORS</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">resources</span><span class="o">=</span><span class="p">{</span>
    <span class="sa">r</span><span class="s2">&quot;/api/*&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;origins&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;http://localhost:3000&quot;</span><span class="p">],</span>
        <span class="s2">&quot;methods&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="s2">&quot;OPTIONS&quot;</span><span class="p">,</span> <span class="s2">&quot;PUT&quot;</span><span class="p">],</span>
        <span class="s2">&quot;allow_headers&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">,</span> <span class="s2">&quot;Authorization&quot;</span><span class="p">],</span>
        <span class="s2">&quot;expose_headers&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Authorization&quot;</span><span class="p">]</span>
    <span class="p">}</span>
<span class="p">})</span>

<span class="n">load_dotenv</span><span class="p">()</span>

<span class="c1"># Database configuration from environment variables</span>
<span class="n">DB_USER</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;DB_USER&quot;</span><span class="p">,</span> <span class="s2">&quot;postgres&quot;</span><span class="p">)</span>
<span class="n">PASSWORD</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;PASSWORD&quot;</span><span class="p">)</span>
<span class="n">PUBLIC_IP_ADDRESS</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;PUBLIC_IP_ADDRESS&quot;</span><span class="p">)</span>
<span class="n">DBNAME</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;DBNAME&quot;</span><span class="p">)</span>

<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;SQLALCHEMY_DATABASE_URI&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="sa">f</span><span class="s2">&quot;postgresql+psycopg2://</span><span class="si">{</span><span class="n">DB_USER</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">PASSWORD</span><span class="si">}</span><span class="s2">@</span><span class="si">{</span><span class="n">PUBLIC_IP_ADDRESS</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">DBNAME</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;SQLALCHEMY_TRACK_MODIFICATIONS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">SQLAlchemy</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;JWT_SECRET_KEY&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;JWT_SECRET_KEY&quot;</span><span class="p">)</span>
<span class="n">jwt</span> <span class="o">=</span> <span class="n">JWTManager</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

<span class="n">openai</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;OPENAI_API_KEY&quot;</span><span class="p">)</span>

<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="c1"># Data Model Entities</span>
<span class="c1"># ------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="User">
<a class="viewcode-back" href="../../backend.html#backend.app.User">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    User model for storing user details.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        id (int): Primary key for the user record.</span>
<span class="sd">        email (str): Unique email address of the user.</span>
<span class="sd">        username (str): Unique username chosen by the user.</span>
<span class="sd">        password_hash (str): Hashed password for security.</span>
<span class="sd">        age (int): Age of the user.</span>
<span class="sd">        gender (str): Gender of the user (e.g., Male, Female, Non-binary, Other).</span>
<span class="sd">        ethnicity (str): Ethnic group the user belongs to (e.g. Hispanic or Latino, white, asian)</span>
<span class="sd">        state (str): state the user lives in. </span>
<span class="sd">        political_affiliation (str): Political leaning (e.g., Democrat, Republican, Independent).</span>
<span class="sd">        voted_bills (JSON): A dictionary storing bill IDs as keys and the corresponding vote value as values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;users&quot;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">120</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">80</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">password_hash</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">age</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">gender</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  
    <span class="n">ethnicity</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">political_affiliation</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  
    
    <span class="n">voted_bills</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">MutableDict</span><span class="o">.</span><span class="n">as_mutable</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">JSON</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="nb">dict</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
<div class="viewcode-block" id="User.set_password">
<a class="viewcode-back" href="../../backend.html#backend.app.User.set_password">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_password</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Hash and set the user&#39;s password.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">password_hash</span> <span class="o">=</span> <span class="n">generate_password_hash</span><span class="p">(</span><span class="n">password</span><span class="p">)</span></div>


<div class="viewcode-block" id="User.check_password">
<a class="viewcode-back" href="../../backend.html#backend.app.User.check_password">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_password</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Verify if the provided password matches the stored hash.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">check_password_hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">password_hash</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="Bill">
<a class="viewcode-back" href="../../backend.html#backend.app.Bill">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Bill</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Bill model for storing congressional bill details.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        id (int): Primary key for the bill record.</span>
<span class="sd">        congress (int): The Congress number that the bill belongs to.</span>
<span class="sd">        bill_type (str): The type of the bill (e.g., &quot;H.R.&quot;, &quot;S.&quot;).</span>
<span class="sd">        bill_number (str): The specific bill number.</span>
<span class="sd">        title (str): The title of the bill.</span>
<span class="sd">        latest_action_date (datetime): The date of the most recent action on the bill.</span>
<span class="sd">        origin_chamber (str): The chamber where the bill originated (e.g., &quot;House&quot;, &quot;Senate&quot;).</span>
<span class="sd">        sponsor (str): The name of the bill&#39;s sponsor.</span>
<span class="sd">        latest_action (dict): A JSON object storing details about the bill&#39;s latest action.</span>
<span class="sd">        update_date (datetime): The date when the bill was last updated.</span>
<span class="sd">        url (str): The URL linking to the bill&#39;s detailed information.</span>
<span class="sd">        text_preview (str): A preview snippet of the bill&#39;s text.</span>
<span class="sd">        full_text (str): The full text of the bill.</span>
<span class="sd">        ai_summary (str): An AI-generated summary of the bill.</span>
<span class="sd">        vote_count (int): A counter to identify bills with the most activity.</span>
<span class="sd">        created_at (datetime): The timestamp when the bill record was created.</span>
<span class="sd">        updated_at (datetime): The timestamp when the bill record was last updated.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;bills&quot;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">congress</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">bill_type</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">bill_number</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">latest_action_date</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">origin_chamber</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">))</span>
    <span class="n">sponsor</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>
    <span class="n">latest_action</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">JSON</span><span class="p">)</span>
    <span class="n">update_date</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">512</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">text_preview</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Text</span><span class="p">)</span>
    <span class="n">full_text</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Text</span><span class="p">)</span>
    <span class="n">ai_summary</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Text</span><span class="p">)</span>
    <span class="n">vote_count</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">upvote_count</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> 
    <span class="n">downvote_count</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">created_at</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">))</span>
    <span class="n">updated_at</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">onupdate</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">))</span></div>


<div class="viewcode-block" id="BillSearchEntry">
<a class="viewcode-back" href="../../backend.html#backend.app.BillSearchEntry">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">BillSearchEntry</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;bill_search_entries&quot;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">bill_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;bills.id&quot;</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">combined_text</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Text</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="build_bill_search_entries">
<a class="viewcode-back" href="../../backend.html#backend.app.build_bill_search_entries">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">build_bill_search_entries</span><span class="p">():</span>
    <span class="n">bills</span> <span class="o">=</span> <span class="n">Bill</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">bill</span> <span class="ow">in</span> <span class="n">bills</span><span class="p">:</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">bill</span><span class="o">.</span><span class="n">title</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bill</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bill</span><span class="o">.</span><span class="n">ai_summary</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bill</span><span class="o">.</span><span class="n">ai_summary</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bill</span><span class="o">.</span><span class="n">full_text</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bill</span><span class="o">.</span><span class="n">full_text</span><span class="p">)</span>
        <span class="c1"># Combine the three fields into one document.</span>
        <span class="n">combined_text</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>
        
        <span class="n">entry</span> <span class="o">=</span> <span class="n">BillSearchEntry</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">bill_id</span><span class="o">=</span><span class="n">bill</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">entry</span><span class="p">:</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="n">BillSearchEntry</span><span class="p">(</span><span class="n">bill_id</span><span class="o">=</span><span class="n">bill</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">combined_text</span><span class="o">=</span><span class="n">combined_text</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">entry</span><span class="o">.</span><span class="n">combined_text</span> <span class="o">=</span> <span class="n">combined_text</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>



<div class="viewcode-block" id="default_demographics">
<a class="viewcode-back" href="../../backend.html#backend.app.default_demographics">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">default_demographics</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;upvote&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;age_distribution&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;under_18&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;18_to_30&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;30_to_60&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;60_plus&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
            <span class="s2">&quot;gender_distribution&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;male&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;female&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;non-binary&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;transgender&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;other&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
            <span class="s2">&quot;ethnicity_distribution&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;hispanic or latino&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;white&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;black or african american&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;asian&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;native hawaiian or other pacific islander&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;american indian or alaska native&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;other&quot;</span><span class="p">:</span> <span class="mi">0</span>
            <span class="p">},</span>
            <span class="s2">&quot;state_distribution&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;al&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;ak&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;az&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;ar&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;ca&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;co&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;ct&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;de&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;fl&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;ga&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;hi&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;il&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;in&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;ia&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;ks&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;ky&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;la&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;me&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;md&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;ma&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;mi&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;mn&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;ms&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;mo&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;mt&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;ne&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;nv&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;nh&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;nj&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;nm&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;ny&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;nc&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;nd&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;oh&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;or&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;pa&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;ri&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;sc&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;sd&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;tn&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;tx&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;ut&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;vt&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;va&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;wa&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;wv&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;wi&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;wy&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;other&quot;</span><span class="p">:</span> <span class="mi">0</span>
            <span class="p">},</span>
            <span class="s2">&quot;political_affiliation_distribution&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;democrat&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;republican&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;independent&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;libertarian&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;green&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;conservative&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;progressive&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;moderate&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;socialist&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;communist&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;other&quot;</span><span class="p">:</span> <span class="mi">0</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="s2">&quot;downvote&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;age_distribution&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;under_18&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;18_to_30&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;30_to_60&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;60_plus&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
            <span class="s2">&quot;gender_distribution&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;male&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;female&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;non-binary&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;transgender&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;other&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
            <span class="s2">&quot;ethnicity_distribution&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;hispanic or latino&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;white&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;black or african american&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;asian&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;native hawaiian or other pacific islander&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;american indian or alaska native&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;other&quot;</span><span class="p">:</span> <span class="mi">0</span>
            <span class="p">},</span>
            <span class="s2">&quot;state_distribution&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;al&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;ak&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;az&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;ar&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;ca&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;co&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;ct&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;de&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;fl&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;ga&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;hi&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;il&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;in&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;ia&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;ks&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;ky&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;la&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;me&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;md&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;ma&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;mi&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;mn&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;ms&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;mo&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;mt&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;ne&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;nv&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;nh&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;nj&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;nm&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;ny&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;nc&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;nd&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;oh&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;or&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;pa&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;ri&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;sc&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;sd&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;tn&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;tx&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;ut&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;vt&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;va&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;wa&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;wv&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;wi&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;wy&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;other&quot;</span><span class="p">:</span> <span class="mi">0</span>
            <span class="p">},</span>
            <span class="s2">&quot;political_affiliation_distribution&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;democrat&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;republican&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;independent&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;libertarian&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;green&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;conservative&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;progressive&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;moderate&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;socialist&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;communist&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;other&quot;</span><span class="p">:</span> <span class="mi">0</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span></div>


<div class="viewcode-block" id="Vote">
<a class="viewcode-back" href="../../backend.html#backend.app.Vote">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Vote</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Association model that stores a vote cast by a user on a bill.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        bill_id (int): Foreign key referencing the Bill being voted on.</span>
<span class="sd">        vote_status (str): The vote status (e.g., &#39;yes&#39;, &#39;no&#39;, &#39;abstain&#39;).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;votes&quot;</span>
    <span class="n">bill_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;bills.id&quot;</span><span class="p">),</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">demographics</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">MutableDict</span><span class="o">.</span><span class="n">as_mutable</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">JSON</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">default_demographics</span><span class="p">)</span></div>


<div class="viewcode-block" id="ScrapeTracking">
<a class="viewcode-back" href="../../backend.html#backend.app.ScrapeTracking">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ScrapeTracking</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Model to track the current offset for scheduled batch scrapes.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        id (int): Primary key for the tracking record.</span>
<span class="sd">        type (str): Type of tracking record (e.g., &quot;offset&quot;).</span>
<span class="sd">        offset (int): Current offset value for batch scraping.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;scrape_tracking&quot;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>

    
<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="c1"># Scraper Class</span>
<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="n">CONGRESS_API_KEY</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;CONGRESS_API_KEY&quot;</span><span class="p">)</span>
<span class="n">API_RATE_LIMIT</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;API_RATE_LIMIT&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">))</span>
<span class="n">CONGRESS_API_BASE</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;CONGRESS_API_BASE&quot;</span><span class="p">,</span> <span class="s2">&quot;https://api.congress.gov/v3&quot;</span><span class="p">)</span>

<span class="c1">#credit to akash for developing this</span>
<div class="viewcode-block" id="CongressionalScraper">
<a class="viewcode-back" href="../../backend.html#backend.app.CongressionalScraper">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CongressionalScraper</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class responsible for scraping congressional bill data from an external API.</span>

<span class="sd">    This class handles rate limiting for API requests and provides methods to:</span>
<span class="sd">      - Fetch detailed bill information from a given URL.</span>
<span class="sd">      - Retrieve a text preview or the full text of a bill.</span>
<span class="sd">      - Process bill data by checking for existing records in the database and inserting or updating them.</span>
<span class="sd">      - Perform batch scraping and daily updates.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        headers (dict): Headers to use for API requests, including the API key.</span>
<span class="sd">        last_request_time (float): Timestamp of the last API request, used for rate limiting.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the CongressionalScraper with API headers and rate limiting parameters.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;X-API-Key&quot;</span><span class="p">:</span> <span class="n">CONGRESS_API_KEY</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_request_time</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_rate_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Implement rate limiting to ensure API requests adhere to the allowed rate.</span>

<span class="sd">        This method calculates the time elapsed since the last request and pauses if needed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">current_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">time_since_last_request</span> <span class="o">=</span> <span class="n">current_time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_request_time</span>
        <span class="n">wait_time</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">API_RATE_LIMIT</span>
        <span class="k">if</span> <span class="n">time_since_last_request</span> <span class="o">&lt;</span> <span class="n">wait_time</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">wait_time</span> <span class="o">-</span> <span class="n">time_since_last_request</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_request_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<div class="viewcode-block" id="CongressionalScraper.get_bill_details">
<a class="viewcode-back" href="../../backend.html#backend.app.CongressionalScraper.get_bill_details">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_bill_details</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fetch detailed bill information from the given URL.</span>

<span class="sd">        Args:</span>
<span class="sd">            url (str): The URL from which to fetch the bill details.</span>
<span class="sd">        Returns:</span>
<span class="sd">            dict: A dictionary containing detailed bill information, or an empty dict on failure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rate_limit</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bill&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error fetching bill details: Status </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exception fetching bill details: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{}</span></div>


<div class="viewcode-block" id="CongressionalScraper.get_bill_text">
<a class="viewcode-back" href="../../backend.html#backend.app.CongressionalScraper.get_bill_text">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_bill_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">congress</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">bill_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">bill_number</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">full_text</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fetch the bill text from the external API.</span>

<span class="sd">        Args:</span>
<span class="sd">            congress (int): The Congress number.</span>
<span class="sd">            bill_type (str): The type of the bill (e.g., &#39;H.R.&#39;, &#39;S.&#39;).</span>
<span class="sd">            bill_number (str): The bill number.</span>
<span class="sd">            full_text (bool): If True, return the full text; otherwise, return a preview.</span>
<span class="sd">        Returns:</span>
<span class="sd">            str: The bill text (either full or a preview), or an empty string on failure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rate_limit</span><span class="p">()</span>
        <span class="n">texts_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">CONGRESS_API_BASE</span><span class="si">}</span><span class="s2">/bill/</span><span class="si">{</span><span class="n">congress</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">bill_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">bill_number</span><span class="si">}</span><span class="s2">/text&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">texts_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                <span class="n">text_versions</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;textVersions&quot;</span><span class="p">,</span> <span class="p">[])</span>
                <span class="k">if</span> <span class="n">text_versions</span><span class="p">:</span>
                    <span class="n">latest_version</span> <span class="o">=</span> <span class="n">text_versions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">formats</span> <span class="o">=</span> <span class="n">latest_version</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;formats&quot;</span><span class="p">,</span> <span class="p">[])</span>
                    <span class="n">htm_format</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">formats</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;Formatted Text&quot;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">htm_format</span><span class="p">:</span>
                        <span class="n">htm_url</span> <span class="o">=</span> <span class="n">htm_format</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;url&quot;</span><span class="p">)</span>
                        <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fetching HTML from: </span><span class="si">{</span><span class="n">htm_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_rate_limit</span><span class="p">()</span>
                        <span class="n">htm_response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">htm_url</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">htm_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                            <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">htm_response</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s1">&#39;html.parser&#39;</span><span class="p">)</span>
                            <span class="n">content</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;pre&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">content</span><span class="p">:</span>
                                <span class="n">text</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">get_text</span><span class="p">(</span><span class="n">separator</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">strip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">full_text</span><span class="p">:</span>
                                    <span class="k">return</span> <span class="n">text</span>
                                <span class="k">return</span> <span class="n">text</span><span class="p">[:</span><span class="mi">1000</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;...&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1000</span> <span class="k">else</span> <span class="n">text</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;No &lt;pre&gt; tag found in HTML content.&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to fetch HTML content: </span><span class="si">{</span><span class="n">htm_response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;No HTML format found for bill text.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="s2">&quot;&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error fetching bill texts: Status </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">. Response: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="s2">&quot;&quot;</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exception fetching bill text: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span></div>


<div class="viewcode-block" id="CongressionalScraper.process_bill">
<a class="viewcode-back" href="../../backend.html#backend.app.CongressionalScraper.process_bill">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">process_bill</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bill_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process a single bill by fetching additional details and inserting or updating it in the database.</span>

<span class="sd">        Args:</span>
<span class="sd">            bill_data (dict): Raw bill data obtained from the external source.</span>
<span class="sd">        Returns:</span>
<span class="sd">            bool: True if a new bill was inserted; False if an existing bill was updated or on error.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">congress</span> <span class="o">=</span> <span class="n">bill_data</span><span class="p">[</span><span class="s2">&quot;congress&quot;</span><span class="p">]</span>
            <span class="n">bill_type</span> <span class="o">=</span> <span class="n">bill_data</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>
            <span class="n">bill_number</span> <span class="o">=</span> <span class="n">bill_data</span><span class="p">[</span><span class="s2">&quot;number&quot;</span><span class="p">]</span>
            <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing bill </span><span class="si">{</span><span class="n">bill_type</span><span class="si">}{</span><span class="n">bill_number</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">detailed_bill</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bill_details</span><span class="p">(</span><span class="n">bill_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;url&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">detailed_bill</span><span class="p">:</span>
                <span class="n">detailed_bill</span> <span class="o">=</span> <span class="n">bill_data</span>

            <span class="c1"># Check if the bill already exists in the database.</span>
            <span class="n">existing_bill</span> <span class="o">=</span> <span class="n">Bill</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span>
                <span class="n">congress</span><span class="o">=</span><span class="n">congress</span><span class="p">,</span> <span class="n">bill_type</span><span class="o">=</span><span class="n">bill_type</span><span class="p">,</span> <span class="n">bill_number</span><span class="o">=</span><span class="n">bill_number</span>
            <span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

            <span class="n">action_date</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">detailed_bill</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;latestAction&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;actionDate&quot;</span><span class="p">)</span>
                <span class="ow">or</span> <span class="n">bill_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;latestAction&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;actionDate&quot;</span><span class="p">)</span>
                <span class="ow">or</span> <span class="n">bill_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;updateDate&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">latest_action_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">action_date</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">action_date</span> <span class="k">else</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">latest_action_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>

            <span class="n">bill_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bill_text</span><span class="p">(</span><span class="n">congress</span><span class="p">,</span> <span class="n">bill_type</span><span class="p">,</span> <span class="n">bill_number</span><span class="p">)</span>
            <span class="n">full_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bill_text</span><span class="p">(</span><span class="n">congress</span><span class="p">,</span> <span class="n">bill_type</span><span class="p">,</span> <span class="n">bill_number</span><span class="p">,</span> <span class="n">full_text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ai_summary</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">bill_text</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">existing_bill</span> <span class="ow">and</span> <span class="n">existing_bill</span><span class="o">.</span><span class="n">ai_summary</span><span class="p">:</span>
                    <span class="n">ai_summary</span> <span class="o">=</span> <span class="n">existing_bill</span><span class="o">.</span><span class="n">ai_summary</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">ai_summary_response</span> <span class="o">=</span> <span class="n">openai</span><span class="o">.</span><span class="n">ChatCompletion</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                            <span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4o&quot;</span><span class="p">,</span>
                            <span class="n">messages</span><span class="o">=</span><span class="p">[</span>
                                <span class="p">{</span>
                                    <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;You are a professional congressional analyst. Summarize the following bill text concisely and objectively in 6-8 sentences.&quot;</span>
                                <span class="p">},</span>
                                <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">bill_text</span><span class="p">}</span>
                            <span class="p">],</span>
                            <span class="n">max_tokens</span><span class="o">=</span><span class="mi">300</span>
                        <span class="p">)</span>
                        <span class="n">ai_summary</span> <span class="o">=</span> <span class="n">ai_summary_response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span>
                        <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generated AI summary for </span><span class="si">{</span><span class="n">bill_type</span><span class="si">}{</span><span class="n">bill_number</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error generating AI summary: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">congress_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://www.congress.gov/bill/</span><span class="si">{</span><span class="n">congress</span><span class="si">}</span><span class="s2">th-congress/</span><span class="si">{</span><span class="n">bill_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">bill_number</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">update_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">bill_data</span><span class="p">[</span><span class="s2">&quot;updateDate&quot;</span><span class="p">],</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                <span class="n">update_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">existing_bill</span><span class="p">:</span>
                <span class="n">existing_bill</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">detailed_bill</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="n">bill_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
                <span class="n">existing_bill</span><span class="o">.</span><span class="n">latest_action</span> <span class="o">=</span> <span class="n">detailed_bill</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;latestAction&quot;</span><span class="p">,</span> <span class="n">bill_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;latestAction&quot;</span><span class="p">,</span> <span class="p">{}))</span>
                <span class="n">existing_bill</span><span class="o">.</span><span class="n">update_date</span> <span class="o">=</span> <span class="n">update_date</span>
                <span class="n">existing_bill</span><span class="o">.</span><span class="n">text_preview</span> <span class="o">=</span> <span class="n">bill_text</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">existing_bill</span><span class="o">.</span><span class="n">ai_summary</span><span class="p">:</span>
                    <span class="n">existing_bill</span><span class="o">.</span><span class="n">ai_summary</span> <span class="o">=</span> <span class="n">ai_summary</span>
                <span class="n">existing_bill</span><span class="o">.</span><span class="n">updated_at</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Updated existing bill </span><span class="si">{</span><span class="n">bill_type</span><span class="si">}{</span><span class="n">bill_number</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="n">new_bill</span> <span class="o">=</span> <span class="n">Bill</span><span class="p">(</span>
                <span class="n">congress</span><span class="o">=</span><span class="n">congress</span><span class="p">,</span>
                <span class="n">bill_type</span><span class="o">=</span><span class="n">bill_type</span><span class="p">,</span>
                <span class="n">bill_number</span><span class="o">=</span><span class="n">bill_number</span><span class="p">,</span>
                <span class="n">title</span><span class="o">=</span><span class="n">detailed_bill</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="n">bill_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)),</span>
                <span class="n">latest_action_date</span><span class="o">=</span><span class="n">latest_action_date</span><span class="p">,</span>
                <span class="n">origin_chamber</span><span class="o">=</span><span class="n">bill_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;originChamber&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                <span class="n">sponsor</span><span class="o">=</span><span class="n">detailed_bill</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sponsor&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;Unknown&quot;</span><span class="p">),</span>
                <span class="n">latest_action</span><span class="o">=</span><span class="n">detailed_bill</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;latestAction&quot;</span><span class="p">,</span> <span class="n">bill_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;latestAction&quot;</span><span class="p">,</span> <span class="p">{})),</span>
                <span class="n">update_date</span><span class="o">=</span><span class="n">update_date</span><span class="p">,</span>
                <span class="n">url</span><span class="o">=</span><span class="n">congress_url</span><span class="p">,</span>
                <span class="n">text_preview</span><span class="o">=</span><span class="n">bill_text</span><span class="p">,</span>
                <span class="n">full_text</span><span class="o">=</span><span class="n">full_text</span><span class="p">,</span>
                <span class="n">ai_summary</span><span class="o">=</span><span class="n">ai_summary</span><span class="p">,</span>
                <span class="n">vote_count</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">created_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">new_bill</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully inserted bill </span><span class="si">{</span><span class="n">bill_type</span><span class="si">}{</span><span class="n">bill_number</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing bill: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Bill data: &quot;</span> <span class="o">+</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">bill_data</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span></div>



<div class="viewcode-block" id="CongressionalScraper.batch_scrape">
<a class="viewcode-back" href="../../backend.html#backend.app.CongressionalScraper.batch_scrape">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">batch_scrape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">congress</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform batch scraping of bills from the external API.</span>

<span class="sd">        Args:</span>
<span class="sd">            congress (int): The Congress number to scrape.</span>
<span class="sd">            offset (int, optional): Pagination offset; defaults to 0.</span>
<span class="sd">            limit (int, optional): Number of bills to process in one batch; defaults to 20.</span>
<span class="sd">        Returns:</span>
<span class="sd">            tuple: A tuple containing:</span>
<span class="sd">                - processed_count (int): Number of new bills processed.</span>
<span class="sd">                - batch_count (int): Number of bills fetched in the current batch.</span>
<span class="sd">                - total_count (int): Total available count of bills from the API.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">CONGRESS_API_BASE</span><span class="si">}</span><span class="s2">/bill/</span><span class="si">{</span><span class="n">congress</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;offset&quot;</span><span class="p">:</span> <span class="n">offset</span><span class="p">,</span>
            <span class="s2">&quot;limit&quot;</span><span class="p">:</span> <span class="n">limit</span><span class="p">,</span>
            <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;json&quot;</span>
        <span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rate_limit</span><span class="p">()</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                <span class="n">bills</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bills&quot;</span><span class="p">,</span> <span class="p">[])</span>
                <span class="n">processed_count</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">bill</span> <span class="ow">in</span> <span class="n">bills</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_bill</span><span class="p">(</span><span class="n">bill</span><span class="p">):</span>
                        <span class="n">processed_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">total_count</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pagination&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">processed_count</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">bills</span><span class="p">),</span> <span class="n">total_count</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in batch scrape: Status </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exception in batch scrape: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="CongressionalScraper.daily_update">
<a class="viewcode-back" href="../../backend.html#backend.app.CongressionalScraper.daily_update">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">daily_update</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform a daily update of new and modified bills from the external API.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: The number of bills processed during the daily update.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">yesterday</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">current_congress</span> <span class="o">=</span> <span class="mi">118</span>  <span class="c1"># Update this value as needed</span>
        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">CONGRESS_API_BASE</span><span class="si">}</span><span class="s2">/bill/</span><span class="si">{</span><span class="n">current_congress</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;fromDateTime&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">yesterday</span><span class="si">}</span><span class="s2">T00:00:00Z&quot;</span><span class="p">,</span>
            <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;json&quot;</span>
        <span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rate_limit</span><span class="p">()</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                <span class="n">bills</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bills&quot;</span><span class="p">,</span> <span class="p">[])</span>
                <span class="n">processed_count</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">bill</span> <span class="ow">in</span> <span class="n">bills</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_bill</span><span class="p">(</span><span class="n">bill</span><span class="p">):</span>
                        <span class="n">processed_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">return</span> <span class="n">processed_count</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in daily update: Status </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">0</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exception in daily update: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span></div>
</div>


<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="c1"># Scheduled Tasks Helper Functions</span>
<span class="c1"># ------------------------------------------------------------------------------</span>

<span class="c1">#credit to akash for developing this</span>
<div class="viewcode-block" id="scheduled_update">
<a class="viewcode-back" href="../../backend.html#backend.app.scheduled_update">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">scheduled_update</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Scheduled task function to perform a daily update of bills.</span>

<span class="sd">    This function is designed to be run on a daily schedule. It initializes</span>
<span class="sd">    the CongressionalScraper and calls the daily_update method, logging the number</span>
<span class="sd">    of bills processed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">app</span><span class="o">.</span><span class="n">app_context</span><span class="p">():</span>
        <span class="n">scraper</span> <span class="o">=</span> <span class="n">CongressionalScraper</span><span class="p">()</span>
        <span class="n">processed</span> <span class="o">=</span> <span class="n">scraper</span><span class="o">.</span><span class="n">daily_update</span><span class="p">()</span>
        <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scheduled update completed: processed </span><span class="si">{</span><span class="n">processed</span><span class="si">}</span><span class="s2"> bills&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="scheduled_batch_scrape">
<a class="viewcode-back" href="../../backend.html#backend.app.scheduled_batch_scrape">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">scheduled_batch_scrape</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Scheduled task function to perform batch scraping of bills.</span>

<span class="sd">    This function is designed to be run on a minute-by-minute schedule to</span>
<span class="sd">    incrementally scrape new bills. It uses the ScrapeTracking model to maintain</span>
<span class="sd">    the current offset and updates the offset after each batch.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">app</span><span class="o">.</span><span class="n">app_context</span><span class="p">():</span>
        <span class="n">scraper</span> <span class="o">=</span> <span class="n">CongressionalScraper</span><span class="p">()</span>
        <span class="n">tracking</span> <span class="o">=</span> <span class="n">ScrapeTracking</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;offset&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">tracking</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tracking</span> <span class="o">=</span> <span class="n">ScrapeTracking</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;offset&quot;</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tracking</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">current_offset</span> <span class="o">=</span> <span class="n">tracking</span><span class="o">.</span><span class="n">offset</span>

        <span class="n">processed</span><span class="p">,</span> <span class="n">batch_count</span><span class="p">,</span> <span class="n">available</span> <span class="o">=</span> <span class="n">scraper</span><span class="o">.</span><span class="n">batch_scrape</span><span class="p">(</span><span class="n">congress</span><span class="o">=</span><span class="mi">118</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">current_offset</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">new_offset</span> <span class="o">=</span> <span class="n">current_offset</span> <span class="o">+</span> <span class="mi">3</span>
        <span class="n">tracking</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">new_offset</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scheduled batch completed: processed </span><span class="si">{</span><span class="n">processed</span><span class="si">}</span><span class="s2"> bills. Next offset: </span><span class="si">{</span><span class="n">new_offset</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="c1"># Security Headers (optional)</span>
<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="c1"># Uncomment the following lines to enable security headers.</span>
<span class="c1"># @app.after_request</span>
<span class="c1"># def set_security_headers(response):</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     Set security headers for each response to mitigate risks such as XSS and clickjacking.</span>
<span class="c1">#</span>
<span class="c1">#     Args:</span>
<span class="c1">#         response: The Flask response object.</span>
<span class="c1">#     Returns:</span>
<span class="c1">#         The response object with additional security headers.</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     response.headers[&#39;Content-Security-Policy&#39;] = (</span>
<span class="c1">#         &quot;default-src &#39;self&#39;; &quot;</span>
<span class="c1">#         &quot;script-src &#39;self&#39;; &quot;</span>
<span class="c1">#         &quot;style-src &#39;self&#39;; &quot;</span>
<span class="c1">#         &quot;img-src &#39;self&#39; data:; &quot;</span>
<span class="c1">#         &quot;font-src &#39;self&#39;; &quot;</span>
<span class="c1">#         &quot;connect-src &#39;self&#39;; &quot;</span>
<span class="c1">#         &quot;frame-ancestors &#39;none&#39;; &quot;</span>
<span class="c1">#         &quot;object-src &#39;none&#39;; &quot;</span>
<span class="c1">#         &quot;base-uri &#39;self&#39;; &quot;</span>
<span class="c1">#         &quot;form-action &#39;self&#39;; &quot;</span>
<span class="c1">#         &quot;upgrade-insecure-requests;&quot;</span>
<span class="c1">#     )</span>
<span class="c1">#     return response</span>

<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="c1"># CLI Commands for Initialization and Reset</span>
<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s2">&quot;init-db&quot;</span><span class="p">)</span>
<span class="nd">@with_appcontext</span>
<span class="k">def</span><span class="w"> </span><span class="nf">init_db</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize the database by creating all necessary tables.</span>

<span class="sd">    This command creates all required database tables and confirms the creation via a CLI message.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">db</span><span class="o">.</span><span class="n">create_all</span><span class="p">()</span>
    <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s2">&quot;Database tables created.&quot;</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s2">&quot;scrape-bills&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--congress&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">118</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Congress number to scrape&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--offset&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Starting offset&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--limit&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of bills to fetch&quot;</span><span class="p">)</span>
<span class="nd">@with_appcontext</span>
<span class="k">def</span><span class="w"> </span><span class="nf">scrape_bills</span><span class="p">(</span><span class="n">congress</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Scrape bills from the specified Congress session.</span>

<span class="sd">    This command performs a batch scrape of legislative bills using the provided parameters,</span>
<span class="sd">    and then updates the BillSearchEntry records used for TF–IDF search.</span>
<span class="sd">    </span>
<span class="sd">    :param congress: Congress number to scrape (default is 118).</span>
<span class="sd">    :param offset: Starting offset for the scraping (default is 0).</span>
<span class="sd">    :param limit: Number of bills to fetch (default is 20).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">scraper</span> <span class="o">=</span> <span class="n">CongressionalScraper</span><span class="p">()</span>
    <span class="n">processed</span><span class="p">,</span> <span class="n">total</span><span class="p">,</span> <span class="n">available</span> <span class="o">=</span> <span class="n">scraper</span><span class="o">.</span><span class="n">batch_scrape</span><span class="p">(</span><span class="n">congress</span><span class="o">=</span><span class="n">congress</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>
    <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scraping complete: Processed </span><span class="si">{</span><span class="n">processed</span><span class="si">}</span><span class="s2"> new bills out of </span><span class="si">{</span><span class="n">total</span><span class="si">}</span><span class="s2"> fetched bills.&quot;</span><span class="p">)</span>
    <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total bills available: </span><span class="si">{</span><span class="n">available</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s2">&quot;Updating BillSearchEntry records for search...&quot;</span><span class="p">)</span>
    <span class="n">build_bill_search_entries</span><span class="p">()</span>
    <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s2">&quot;BillSearchEntry records updated.&quot;</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s2">&quot;schedule-updates&quot;</span><span class="p">)</span>
<span class="nd">@with_appcontext</span>
<span class="k">def</span><span class="w"> </span><span class="nf">init_scheduler</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Start the background scheduler for periodic scraping tasks.</span>

<span class="sd">    This command initializes and starts a BackgroundScheduler that schedules:</span>
<span class="sd">    - A batch scraping task to run every minute.</span>
<span class="sd">    - A daily update task to run every 24 hours.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">scheduler</span> <span class="o">=</span> <span class="n">BackgroundScheduler</span><span class="p">()</span>
    <span class="n">scheduler</span><span class="o">.</span><span class="n">add_job</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">scheduled_batch_scrape</span><span class="p">,</span> <span class="n">trigger</span><span class="o">=</span><span class="s2">&quot;interval&quot;</span><span class="p">,</span> <span class="n">minutes</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">scheduler</span><span class="o">.</span><span class="n">add_job</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">scheduled_update</span><span class="p">,</span> <span class="n">trigger</span><span class="o">=</span><span class="s2">&quot;interval&quot;</span><span class="p">,</span> <span class="n">hours</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
    <span class="n">scheduler</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s2">&quot;Scheduler started with daily and batch scraping tasks.&quot;</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s2">&quot;reset-db&quot;</span><span class="p">)</span>
<span class="nd">@with_appcontext</span>
<span class="k">def</span><span class="w"> </span><span class="nf">reset_db</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reset the database by dropping and recreating all tables.</span>
<span class="sd">    </span>
<span class="sd">    This command drops the public schema (with CASCADE) and then recreates it, </span>
<span class="sd">    ensuring that all dependent objects are removed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Drop the entire public schema (with cascade) and then recreate it.</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;DROP SCHEMA public CASCADE;&quot;</span><span class="p">))</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;CREATE SCHEMA public;&quot;</span><span class="p">))</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="c1"># Create all tables from the models.</span>
    <span class="n">db</span><span class="o">.</span><span class="n">create_all</span><span class="p">()</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    
    <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s2">&quot;Database reset complete.&quot;</span><span class="p">)</span>
<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="c1"># User API Endpoints</span>
<span class="c1"># ------------------------------------------------------------------------------</span>

<div class="viewcode-block" id="register">
<a class="viewcode-back" href="../../backend.html#backend.app.register">[docs]</a>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/api/auth/register&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">register</span><span class="p">():</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;email&quot;</span><span class="p">)</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;username&quot;</span><span class="p">)</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;password&quot;</span><span class="p">)</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">age</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;age&quot;</span><span class="p">))</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid age format&quot;</span><span class="p">}),</span> <span class="mi">400</span> 

    <span class="n">gender</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gender&quot;</span><span class="p">)</span>
    <span class="n">ethnicity</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ethnicity&quot;</span><span class="p">)</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;state&quot;</span><span class="p">)</span>
    <span class="n">political_affiliation</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;political_affiliation&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">email</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">username</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">password</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">age</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">gender</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">state</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">political_affiliation</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Missing required fields&quot;</span><span class="p">}),</span> <span class="mi">400</span>
    
    <span class="k">if</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">or_</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">email</span> <span class="o">==</span> <span class="n">email</span><span class="p">,</span> <span class="n">User</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">username</span><span class="p">))</span><span class="o">.</span><span class="n">first</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;User with given email or username already exists&quot;</span><span class="p">}),</span> <span class="mi">400</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="n">age</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Given age is invalid&quot;</span><span class="p">}),</span> <span class="mi">400</span>
    
    <span class="n">acceptable_genders</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;male&quot;</span><span class="p">,</span> <span class="s2">&quot;female&quot;</span><span class="p">,</span> <span class="s2">&quot;non-binary&quot;</span><span class="p">,</span> <span class="s2">&quot;transgender&quot;</span><span class="p">,</span> <span class="s2">&quot;other&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">gender</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">acceptable_genders</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Given gender is invalid&quot;</span><span class="p">}),</span> <span class="mi">400</span>

    <span class="n">acceptable_ethnicities</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;hispanic or latino&quot;</span><span class="p">,</span> <span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="s2">&quot;black or african american&quot;</span><span class="p">,</span> <span class="s2">&quot;asian&quot;</span><span class="p">,</span> 
                            <span class="s2">&quot;native hawaiian or other pacific islander&quot;</span><span class="p">,</span> <span class="s2">&quot;american indian or alaska native&quot;</span><span class="p">,</span> <span class="s2">&quot;other&quot;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">ethnicity</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">acceptable_ethnicities</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Given ethnicity is invalid&quot;</span><span class="p">}),</span> <span class="mi">400</span>

    <span class="n">acceptable_states</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;alabama&quot;</span><span class="p">:</span> <span class="s2">&quot;al&quot;</span><span class="p">,</span> <span class="s2">&quot;alaska&quot;</span><span class="p">:</span> <span class="s2">&quot;ak&quot;</span><span class="p">,</span> <span class="s2">&quot;arizona&quot;</span><span class="p">:</span> <span class="s2">&quot;az&quot;</span><span class="p">,</span> <span class="s2">&quot;arkansas&quot;</span><span class="p">:</span> <span class="s2">&quot;ar&quot;</span><span class="p">,</span> <span class="s2">&quot;california&quot;</span><span class="p">:</span> <span class="s2">&quot;ca&quot;</span><span class="p">,</span>
        <span class="s2">&quot;colorado&quot;</span><span class="p">:</span> <span class="s2">&quot;co&quot;</span><span class="p">,</span> <span class="s2">&quot;connecticut&quot;</span><span class="p">:</span> <span class="s2">&quot;ct&quot;</span><span class="p">,</span> <span class="s2">&quot;delaware&quot;</span><span class="p">:</span> <span class="s2">&quot;de&quot;</span><span class="p">,</span> <span class="s2">&quot;florida&quot;</span><span class="p">:</span> <span class="s2">&quot;fl&quot;</span><span class="p">,</span> <span class="s2">&quot;georgia&quot;</span><span class="p">:</span> <span class="s2">&quot;ga&quot;</span><span class="p">,</span>
        <span class="s2">&quot;hawaii&quot;</span><span class="p">:</span> <span class="s2">&quot;hi&quot;</span><span class="p">,</span> <span class="s2">&quot;idaho&quot;</span><span class="p">:</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;illinois&quot;</span><span class="p">:</span> <span class="s2">&quot;il&quot;</span><span class="p">,</span> <span class="s2">&quot;indiana&quot;</span><span class="p">:</span> <span class="s2">&quot;in&quot;</span><span class="p">,</span> <span class="s2">&quot;iowa&quot;</span><span class="p">:</span> <span class="s2">&quot;ia&quot;</span><span class="p">,</span>
        <span class="s2">&quot;kansas&quot;</span><span class="p">:</span> <span class="s2">&quot;ks&quot;</span><span class="p">,</span> <span class="s2">&quot;kentucky&quot;</span><span class="p">:</span> <span class="s2">&quot;ky&quot;</span><span class="p">,</span> <span class="s2">&quot;louisiana&quot;</span><span class="p">:</span> <span class="s2">&quot;la&quot;</span><span class="p">,</span> <span class="s2">&quot;maine&quot;</span><span class="p">:</span> <span class="s2">&quot;me&quot;</span><span class="p">,</span> <span class="s2">&quot;maryland&quot;</span><span class="p">:</span> <span class="s2">&quot;md&quot;</span><span class="p">,</span>
        <span class="s2">&quot;massachusetts&quot;</span><span class="p">:</span> <span class="s2">&quot;ma&quot;</span><span class="p">,</span> <span class="s2">&quot;michigan&quot;</span><span class="p">:</span> <span class="s2">&quot;mi&quot;</span><span class="p">,</span> <span class="s2">&quot;minnesota&quot;</span><span class="p">:</span> <span class="s2">&quot;mn&quot;</span><span class="p">,</span> <span class="s2">&quot;mississippi&quot;</span><span class="p">:</span> <span class="s2">&quot;ms&quot;</span><span class="p">,</span>
        <span class="s2">&quot;missouri&quot;</span><span class="p">:</span> <span class="s2">&quot;mo&quot;</span><span class="p">,</span> <span class="s2">&quot;montana&quot;</span><span class="p">:</span> <span class="s2">&quot;mt&quot;</span><span class="p">,</span> <span class="s2">&quot;nebraska&quot;</span><span class="p">:</span> <span class="s2">&quot;ne&quot;</span><span class="p">,</span> <span class="s2">&quot;nevada&quot;</span><span class="p">:</span> <span class="s2">&quot;nv&quot;</span><span class="p">,</span> <span class="s2">&quot;new hampshire&quot;</span><span class="p">:</span> <span class="s2">&quot;nh&quot;</span><span class="p">,</span>
        <span class="s2">&quot;new jersey&quot;</span><span class="p">:</span> <span class="s2">&quot;nj&quot;</span><span class="p">,</span> <span class="s2">&quot;new mexico&quot;</span><span class="p">:</span> <span class="s2">&quot;nm&quot;</span><span class="p">,</span> <span class="s2">&quot;new york&quot;</span><span class="p">:</span> <span class="s2">&quot;ny&quot;</span><span class="p">,</span> <span class="s2">&quot;north carolina&quot;</span><span class="p">:</span> <span class="s2">&quot;nc&quot;</span><span class="p">,</span>
        <span class="s2">&quot;north dakota&quot;</span><span class="p">:</span> <span class="s2">&quot;nd&quot;</span><span class="p">,</span> <span class="s2">&quot;ohio&quot;</span><span class="p">:</span> <span class="s2">&quot;oh&quot;</span><span class="p">,</span> <span class="s2">&quot;oklahoma&quot;</span><span class="p">:</span> <span class="s2">&quot;ok&quot;</span><span class="p">,</span> <span class="s2">&quot;oregon&quot;</span><span class="p">:</span> <span class="s2">&quot;or&quot;</span><span class="p">,</span> <span class="s2">&quot;pennsylvania&quot;</span><span class="p">:</span> <span class="s2">&quot;pa&quot;</span><span class="p">,</span>
        <span class="s2">&quot;rhode island&quot;</span><span class="p">:</span> <span class="s2">&quot;ri&quot;</span><span class="p">,</span> <span class="s2">&quot;south carolina&quot;</span><span class="p">:</span> <span class="s2">&quot;sc&quot;</span><span class="p">,</span> <span class="s2">&quot;south dakota&quot;</span><span class="p">:</span> <span class="s2">&quot;sd&quot;</span><span class="p">,</span> <span class="s2">&quot;tennessee&quot;</span><span class="p">:</span> <span class="s2">&quot;tn&quot;</span><span class="p">,</span>
        <span class="s2">&quot;texas&quot;</span><span class="p">:</span> <span class="s2">&quot;tx&quot;</span><span class="p">,</span> <span class="s2">&quot;utah&quot;</span><span class="p">:</span> <span class="s2">&quot;ut&quot;</span><span class="p">,</span> <span class="s2">&quot;vermont&quot;</span><span class="p">:</span> <span class="s2">&quot;vt&quot;</span><span class="p">,</span> <span class="s2">&quot;virginia&quot;</span><span class="p">:</span> <span class="s2">&quot;va&quot;</span><span class="p">,</span> <span class="s2">&quot;washington&quot;</span><span class="p">:</span> <span class="s2">&quot;wa&quot;</span><span class="p">,</span>
        <span class="s2">&quot;west virginia&quot;</span><span class="p">:</span> <span class="s2">&quot;wv&quot;</span><span class="p">,</span> <span class="s2">&quot;wisconsin&quot;</span><span class="p">:</span> <span class="s2">&quot;wi&quot;</span><span class="p">,</span> <span class="s2">&quot;wyoming&quot;</span><span class="p">:</span> <span class="s2">&quot;wy&quot;</span><span class="p">,</span> <span class="s2">&quot;other&quot;</span><span class="p">:</span> <span class="s2">&quot;other&quot;</span>
    <span class="p">}</span>

    <span class="n">state</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">acceptable_states</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">acceptable_states</span><span class="p">[</span><span class="n">state</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">acceptable_states</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Given state is invalid&quot;</span><span class="p">}),</span> <span class="mi">400</span>
    
    <span class="n">acceptable_political_affiliations</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;libertarian&quot;</span><span class="p">,</span> <span class="s2">&quot;conservative&quot;</span><span class="p">,</span> <span class="s2">&quot;progressive&quot;</span><span class="p">,</span> <span class="s2">&quot;moderate&quot;</span><span class="p">,</span> 
        <span class="s2">&quot;socialist&quot;</span><span class="p">,</span> <span class="s2">&quot;communist&quot;</span><span class="p">,</span> <span class="s2">&quot;other&quot;</span>
    <span class="p">]</span>
    
    <span class="k">if</span> <span class="n">political_affiliation</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">acceptable_political_affiliations</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Given political affiliation is invalid&quot;</span><span class="p">}),</span> <span class="mi">400</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">age</span><span class="o">=</span><span class="n">age</span><span class="p">,</span> <span class="n">gender</span><span class="o">=</span><span class="n">gender</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> 
                <span class="n">ethnicity</span><span class="o">=</span><span class="n">ethnicity</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> 
                <span class="n">political_affiliation</span><span class="o">=</span><span class="n">political_affiliation</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
                <span class="n">voted_bills</span><span class="o">=</span><span class="p">{})</span>

    <span class="n">user</span><span class="o">.</span><span class="n">set_password</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="n">access_token</span> <span class="o">=</span> <span class="n">create_access_token</span><span class="p">(</span><span class="n">identity</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> <span class="n">expires_delta</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;User created successfully&quot;</span><span class="p">,</span>
        <span class="s2">&quot;access_token&quot;</span><span class="p">:</span> <span class="n">access_token</span><span class="p">,</span>
        <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
            <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span>
        <span class="p">}</span>
    <span class="p">}),</span> <span class="mi">201</span></div>


<div class="viewcode-block" id="get_users">
<a class="viewcode-back" href="../../backend.html#backend.app.get_users">[docs]</a>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/api/auth/users&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_users</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    API endpoint to retrieve all registered users.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A JSON list of users, where each user includes the id, email, and username.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">users</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">users_list</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">}</span> <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">users</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">users_list</span><span class="p">),</span> <span class="mi">200</span></div>


<div class="viewcode-block" id="login">
<a class="viewcode-back" href="../../backend.html#backend.app.login">[docs]</a>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/api/auth/login&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">login</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    API endpoint for user login.</span>

<span class="sd">    Expects a JSON payload with &#39;username_or_email&#39; and &#39;password&#39;.</span>
<span class="sd">    Returns an access token and user details if credentials are valid.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="n">username_or_email</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;email&quot;</span><span class="p">)</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;password&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">username_or_email</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">password</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Missing required fields&quot;</span><span class="p">}),</span> <span class="mi">400</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">or_</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">email</span> <span class="o">==</span> <span class="n">username_or_email</span><span class="p">,</span> <span class="n">User</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">username_or_email</span><span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">check_password</span><span class="p">(</span><span class="n">password</span><span class="p">):</span>
        <span class="n">access_token</span> <span class="o">=</span> <span class="n">create_access_token</span><span class="p">(</span><span class="n">identity</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> <span class="n">expires_delta</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Logged in successfully&quot;</span><span class="p">,</span>
            <span class="s2">&quot;access_token&quot;</span><span class="p">:</span> <span class="n">access_token</span><span class="p">,</span>
            <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
                <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span>
            <span class="p">}</span>
        <span class="p">}),</span> <span class="mi">200</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid credentials&quot;</span><span class="p">}),</span> <span class="mi">401</span></div>



<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="c1"># Helper Function for Serialization</span>
<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="c1">#credit to akash for developing this</span>
<div class="viewcode-block" id="serialize_bill">
<a class="viewcode-back" href="../../backend.html#backend.app.serialize_bill">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">serialize_bill</span><span class="p">(</span><span class="n">bill</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper function to serialize a Bill object for JSON responses.</span>

<span class="sd">    Converts datetime fields to ISO 8601 strings.</span>

<span class="sd">    Args:</span>
<span class="sd">        bill (Bill): A Bill model instance.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary representation of the bill.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">bill</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
        <span class="s2">&quot;congress&quot;</span><span class="p">:</span> <span class="n">bill</span><span class="o">.</span><span class="n">congress</span><span class="p">,</span>
        <span class="s2">&quot;bill_type&quot;</span><span class="p">:</span> <span class="n">bill</span><span class="o">.</span><span class="n">bill_type</span><span class="p">,</span>
        <span class="s2">&quot;bill_number&quot;</span><span class="p">:</span> <span class="n">bill</span><span class="o">.</span><span class="n">bill_number</span><span class="p">,</span>
        <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">bill</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
        <span class="s2">&quot;latest_action_date&quot;</span><span class="p">:</span> <span class="n">bill</span><span class="o">.</span><span class="n">latest_action_date</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span> <span class="k">if</span> <span class="n">bill</span><span class="o">.</span><span class="n">latest_action_date</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;origin_chamber&quot;</span><span class="p">:</span> <span class="n">bill</span><span class="o">.</span><span class="n">origin_chamber</span><span class="p">,</span>
        <span class="s2">&quot;sponsor&quot;</span><span class="p">:</span> <span class="n">bill</span><span class="o">.</span><span class="n">sponsor</span><span class="p">,</span>
        <span class="s2">&quot;latest_action&quot;</span><span class="p">:</span> <span class="n">bill</span><span class="o">.</span><span class="n">latest_action</span><span class="p">,</span>
        <span class="s2">&quot;update_date&quot;</span><span class="p">:</span> <span class="n">bill</span><span class="o">.</span><span class="n">update_date</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span> <span class="k">if</span> <span class="n">bill</span><span class="o">.</span><span class="n">update_date</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="n">bill</span><span class="o">.</span><span class="n">url</span><span class="p">,</span>
        <span class="s2">&quot;text_preview&quot;</span><span class="p">:</span> <span class="n">bill</span><span class="o">.</span><span class="n">text_preview</span><span class="p">,</span>
        <span class="s2">&quot;full_text&quot;</span><span class="p">:</span> <span class="n">bill</span><span class="o">.</span><span class="n">full_text</span><span class="p">,</span>
        <span class="s2">&quot;ai_summary&quot;</span><span class="p">:</span> <span class="n">bill</span><span class="o">.</span><span class="n">ai_summary</span><span class="p">,</span>
        <span class="s2">&quot;vote_count&quot;</span><span class="p">:</span> <span class="n">bill</span><span class="o">.</span><span class="n">vote_count</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">bill</span><span class="p">,</span> <span class="s1">&#39;vote_count&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;upvote_count&quot;</span><span class="p">:</span> <span class="n">bill</span><span class="o">.</span><span class="n">upvote_count</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">bill</span><span class="p">,</span> <span class="s1">&#39;upvote_count&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;downvote_count&quot;</span><span class="p">:</span> <span class="n">bill</span><span class="o">.</span><span class="n">downvote_count</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">bill</span><span class="p">,</span> <span class="s1">&#39;downvote_count&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="n">bill</span><span class="o">.</span><span class="n">created_at</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span> <span class="k">if</span> <span class="n">bill</span><span class="o">.</span><span class="n">created_at</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;updated_at&quot;</span><span class="p">:</span> <span class="n">bill</span><span class="o">.</span><span class="n">updated_at</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span> <span class="k">if</span> <span class="n">bill</span><span class="o">.</span><span class="n">updated_at</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="p">}</span></div>


<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="c1"># Bill API Endpoints</span>
<span class="c1"># ------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="get_bills">
<a class="viewcode-back" href="../../backend.html#backend.app.get_bills">[docs]</a>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/api/bills&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_bills</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    API endpoint to retrieve bills with pagination, sorting, and optional filtering by chamber.</span>

<span class="sd">    Query Parameters:</span>
<span class="sd">        page (int): The page number (default: 1).</span>
<span class="sd">        per_page (int): The number of bills per page (default: 20).</span>
<span class="sd">        sort (str): The column to sort by (default: &quot;created_at&quot;).</span>
<span class="sd">        sort_dir (int): Sort direction; 1 for ascending, -1 for descending (default: -1).</span>
<span class="sd">        chamber (str): The chamber to filter bills by (e.g., &quot;House&quot;, &quot;Senate&quot;, or &quot;all&quot;).</span>

<span class="sd">    Returns:</span>
<span class="sd">        JSON response containing the serialized list of bills and pagination metadata.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">page</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;page&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">per_page</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;per_page&quot;</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
        <span class="n">sort_by</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sort&quot;</span><span class="p">,</span> <span class="s2">&quot;created_at&quot;</span><span class="p">)</span>
        <span class="n">sort_dir</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sort_dir&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">chamber</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;chamber&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">query</span> <span class="o">=</span> <span class="n">Bill</span><span class="o">.</span><span class="n">query</span>
        <span class="k">if</span> <span class="n">chamber</span> <span class="ow">and</span> <span class="n">chamber</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Bill</span><span class="o">.</span><span class="n">origin_chamber</span> <span class="o">==</span> <span class="n">chamber</span><span class="p">)</span>

        <span class="n">sort_column</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">Bill</span><span class="p">,</span> <span class="n">sort_by</span><span class="p">,</span> <span class="n">Bill</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span>
        <span class="n">sort_column</span> <span class="o">=</span> <span class="n">sort_column</span><span class="o">.</span><span class="n">desc</span><span class="p">()</span> <span class="k">if</span> <span class="n">sort_dir</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="n">sort_column</span><span class="o">.</span><span class="n">asc</span><span class="p">()</span>

        <span class="n">pagination</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">sort_column</span><span class="p">)</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="n">page</span><span class="o">=</span><span class="n">page</span><span class="p">,</span> <span class="n">per_page</span><span class="o">=</span><span class="n">per_page</span><span class="p">,</span> <span class="n">error_out</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">bills</span> <span class="o">=</span> <span class="n">pagination</span><span class="o">.</span><span class="n">items</span>

        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
            <span class="s2">&quot;bills&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">serialize_bill</span><span class="p">(</span><span class="n">bill</span><span class="p">)</span> <span class="k">for</span> <span class="n">bill</span> <span class="ow">in</span> <span class="n">bills</span><span class="p">],</span>
            <span class="s2">&quot;pagination&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;page&quot;</span><span class="p">:</span> <span class="n">page</span><span class="p">,</span>
                <span class="s2">&quot;per_page&quot;</span><span class="p">:</span> <span class="n">per_page</span><span class="p">,</span>
                <span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="n">pagination</span><span class="o">.</span><span class="n">total</span><span class="p">,</span>
                <span class="s2">&quot;pages&quot;</span><span class="p">:</span> <span class="n">pagination</span><span class="o">.</span><span class="n">pages</span>
            <span class="p">}</span>
        <span class="p">})</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error fetching bills: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}),</span> <span class="mi">500</span></div>



<div class="viewcode-block" id="get_trending_bills">
<a class="viewcode-back" href="../../backend.html#backend.app.get_trending_bills">[docs]</a>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/api/bills/trending&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_trending_bills</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    API endpoint to retrieve the top 10 trending bills sorted by vote count in descending order.</span>

<span class="sd">    Returns:</span>
<span class="sd">        JSON response containing a list of serialized trending bills.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">bills</span> <span class="o">=</span> <span class="n">Bill</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Bill</span><span class="o">.</span><span class="n">vote_count</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">([</span><span class="n">serialize_bill</span><span class="p">(</span><span class="n">bill</span><span class="p">)</span> <span class="k">for</span> <span class="n">bill</span> <span class="ow">in</span> <span class="n">bills</span><span class="p">])</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error fetching trending bills: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}),</span> <span class="mi">500</span></div>



<div class="viewcode-block" id="get_full_bill">
<a class="viewcode-back" href="../../backend.html#backend.app.get_full_bill">[docs]</a>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/api/bills/&lt;int:bill_id&gt;/full&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_full_bill</span><span class="p">(</span><span class="n">bill_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    API endpoint to retrieve full details for a specific bill by its id.</span>

<span class="sd">    Args:</span>
<span class="sd">        bill_id (int): The unique id of the bill.</span>

<span class="sd">    Returns:</span>
<span class="sd">        JSON response containing the serialized bill details or a 404 error if not found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">bill</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Bill</span><span class="p">,</span> <span class="n">bill_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">bill</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Bill not found&quot;</span><span class="p">}),</span> <span class="mi">404</span>

        <span class="k">if</span> <span class="n">bill</span><span class="o">.</span><span class="n">url</span><span class="p">:</span>
            <span class="n">bill</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">bill</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;api.congress.gov&quot;</span><span class="p">,</span> <span class="s2">&quot;www.congress.gov&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">serialize_bill</span><span class="p">(</span><span class="n">bill</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error fetching full bill: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}),</span> <span class="mi">500</span></div>



<div class="viewcode-block" id="search_bills">
<a class="viewcode-back" href="../../backend.html#backend.app.search_bills">[docs]</a>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/api/search&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">search_bills</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    API endpoint to search bills based on a keyword.</span>

<span class="sd">    Query Parameters:</span>
<span class="sd">        keyword (str): The search keyword to look for in the bill&#39;s title, AI summary, or text preview.</span>

<span class="sd">    Returns:</span>
<span class="sd">        JSON response containing a list of serialized bills matching the search criteria.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">keyword</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;keyword&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">keyword</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">([])</span>

        <span class="n">bills</span> <span class="o">=</span> <span class="n">Bill</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">or_</span><span class="p">(</span>
                <span class="n">Bill</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">ilike</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;%</span><span class="si">{</span><span class="n">keyword</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">),</span>
                <span class="n">Bill</span><span class="o">.</span><span class="n">ai_summary</span><span class="o">.</span><span class="n">ilike</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;%</span><span class="si">{</span><span class="n">keyword</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">),</span>
                <span class="n">Bill</span><span class="o">.</span><span class="n">text_preview</span><span class="o">.</span><span class="n">ilike</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;%</span><span class="si">{</span><span class="n">keyword</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">jsonify</span><span class="p">([</span><span class="n">serialize_bill</span><span class="p">(</span><span class="n">bill</span><span class="p">)</span> <span class="k">for</span> <span class="n">bill</span> <span class="ow">in</span> <span class="n">bills</span><span class="p">])</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in search: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}),</span> <span class="mi">500</span></div>

    
<div class="viewcode-block" id="search_bills_tfidf">
<a class="viewcode-back" href="../../backend.html#backend.app.search_bills_tfidf">[docs]</a>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/api/search_tfidf&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">search_bills_tfidf</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    API endpoint to search bills using TF–IDF to rank documents based on relevance.</span>
<span class="sd">    </span>
<span class="sd">    Query Parameters:</span>
<span class="sd">        keyword (str): The search keyword to look for in the bill&#39;s title, AI summary, and text preview.</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        JSON response containing a list of serialized bills matching the search criteria.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">keyword</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;keyword&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">keyword</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">([])</span>

        <span class="c1"># Retrieve the prebuilt search entries.</span>
        <span class="n">entries</span> <span class="o">=</span> <span class="n">BillSearchEntry</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">entries</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">([])</span>

        <span class="n">documents</span> <span class="o">=</span> <span class="p">[</span><span class="n">entry</span><span class="o">.</span><span class="n">combined_text</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">]</span>
        <span class="n">bill_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">entry</span><span class="o">.</span><span class="n">bill_id</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">]</span>

        <span class="c1"># Initialize the vectorizer and compute the TF–IDF matrix.</span>
        <span class="n">vectorizer</span> <span class="o">=</span> <span class="n">TfidfVectorizer</span><span class="p">(</span><span class="n">stop_words</span><span class="o">=</span><span class="s2">&quot;english&quot;</span><span class="p">)</span>
        <span class="n">tfidf_matrix</span> <span class="o">=</span> <span class="n">vectorizer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">documents</span><span class="p">)</span>
        
        <span class="c1"># Transform the query into the TF–IDF vector space.</span>
        <span class="n">query_vec</span> <span class="o">=</span> <span class="n">vectorizer</span><span class="o">.</span><span class="n">transform</span><span class="p">([</span><span class="n">keyword</span><span class="p">])</span>
        
        <span class="c1"># Compute cosine similarities.</span>
        <span class="n">similarities</span> <span class="o">=</span> <span class="n">cosine_similarity</span><span class="p">(</span><span class="n">query_vec</span><span class="p">,</span> <span class="n">tfidf_matrix</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        
        <span class="c1"># Sort indices by similarity (highest first) and filter to include only positive matches.</span>
        <span class="n">sorted_indices</span> <span class="o">=</span> <span class="n">similarities</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">top_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sorted_indices</span> <span class="k">if</span> <span class="n">similarities</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">][:</span><span class="mi">20</span><span class="p">]</span>

        <span class="c1"># Build a list of serialized bills in order of relevance.</span>
        <span class="n">bills</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">top_indices</span><span class="p">:</span>
            <span class="n">bill</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Bill</span><span class="p">,</span> <span class="n">bill_ids</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">bill</span><span class="p">:</span>
                <span class="n">bills</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">serialize_bill</span><span class="p">(</span><span class="n">bill</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">bills</span><span class="p">)</span>
    
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error in TF–IDF search: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;An error occurred during search.&quot;</span><span class="p">}),</span> <span class="mi">500</span></div>


<div class="viewcode-block" id="vote_on_bill">
<a class="viewcode-back" href="../../backend.html#backend.app.vote_on_bill">[docs]</a>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/api/bills/&lt;int:bill_id&gt;/vote&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="nd">@jwt_required</span><span class="p">()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">vote_on_bill</span><span class="p">(</span><span class="n">bill_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Endpoint to allow a user to vote on a bill.</span>

<span class="sd">    It handles three vote statuses:</span>

<span class="sd">    - &quot;upvote&quot; or &quot;downvote&quot;: Casting or changing a vote.</span>
<span class="sd">    - &quot;none&quot;: Removing an existing vote.</span>

<span class="sd">    It updates the Vote entity&#39;s demographic counters and the User&#39;s `voted_bills` accordingly.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
        <span class="n">vote_status</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;vote_status&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">vote_status</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;upvote&quot;</span><span class="p">,</span> <span class="s2">&quot;downvote&quot;</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid vote status. Must be &#39;upvote&#39;, &#39;downvote&#39;, or &#39;none&#39;.&quot;</span><span class="p">}),</span> <span class="mi">400</span>

        <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_jwt_identity</span><span class="p">()</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;User not found.&quot;</span><span class="p">}),</span> <span class="mi">404</span>

        <span class="n">bill</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Bill</span><span class="p">,</span> <span class="n">bill_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">bill</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Bill not found.&quot;</span><span class="p">}),</span> <span class="mi">404</span>

        <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">age</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;User age not specified.&quot;</span><span class="p">}),</span> <span class="mi">400</span>

        <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">age</span> <span class="o">&lt;</span> <span class="mi">18</span><span class="p">:</span>
            <span class="n">age_category</span> <span class="o">=</span> <span class="s2">&quot;under_18&quot;</span>
        <span class="k">elif</span> <span class="mi">18</span> <span class="o">&lt;=</span> <span class="n">user</span><span class="o">.</span><span class="n">age</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">:</span>
            <span class="n">age_category</span> <span class="o">=</span> <span class="s2">&quot;18_to_30&quot;</span>
        <span class="k">elif</span> <span class="mi">30</span> <span class="o">&lt;=</span> <span class="n">user</span><span class="o">.</span><span class="n">age</span> <span class="o">&lt;</span> <span class="mi">60</span><span class="p">:</span>
            <span class="n">age_category</span> <span class="o">=</span> <span class="s2">&quot;30_to_60&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">age_category</span> <span class="o">=</span> <span class="s2">&quot;60_plus&quot;</span>

        <span class="c1"># Normalize demographics.</span>
        <span class="n">gender</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">gender</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">gender</span> <span class="k">else</span> <span class="s2">&quot;other&quot;</span>
        <span class="k">if</span> <span class="n">gender</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;male&quot;</span><span class="p">,</span> <span class="s2">&quot;female&quot;</span><span class="p">,</span> <span class="s2">&quot;non-binary&quot;</span><span class="p">,</span> <span class="s2">&quot;transgender&quot;</span><span class="p">,</span> <span class="s2">&quot;other&quot;</span><span class="p">]:</span>
            <span class="n">gender</span> <span class="o">=</span> <span class="s2">&quot;other&quot;</span>

        <span class="n">ethnicity</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">ethnicity</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">ethnicity</span> <span class="k">else</span> <span class="s2">&quot;other&quot;</span>
        <span class="n">valid_ethnicities</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;hispanic or latino&quot;</span><span class="p">,</span> <span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="s2">&quot;black or african american&quot;</span><span class="p">,</span> <span class="s2">&quot;asian&quot;</span><span class="p">,</span>
            <span class="s2">&quot;native hawaiian or other pacific islander&quot;</span><span class="p">,</span> <span class="s2">&quot;american indian or alaska native&quot;</span><span class="p">,</span> <span class="s2">&quot;other&quot;</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">ethnicity</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_ethnicities</span><span class="p">:</span>
            <span class="n">ethnicity</span> <span class="o">=</span> <span class="s2">&quot;other&quot;</span>

        <span class="n">state</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">state</span> <span class="k">else</span> <span class="s2">&quot;other&quot;</span>
        <span class="n">valid_states</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;al&quot;</span><span class="p">,</span> <span class="s2">&quot;ak&quot;</span><span class="p">,</span> <span class="s2">&quot;az&quot;</span><span class="p">,</span> <span class="s2">&quot;ar&quot;</span><span class="p">,</span> <span class="s2">&quot;ca&quot;</span><span class="p">,</span> <span class="s2">&quot;co&quot;</span><span class="p">,</span> <span class="s2">&quot;ct&quot;</span><span class="p">,</span> <span class="s2">&quot;de&quot;</span><span class="p">,</span> <span class="s2">&quot;fl&quot;</span><span class="p">,</span> <span class="s2">&quot;ga&quot;</span><span class="p">,</span>
            <span class="s2">&quot;hi&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;il&quot;</span><span class="p">,</span> <span class="s2">&quot;in&quot;</span><span class="p">,</span> <span class="s2">&quot;ia&quot;</span><span class="p">,</span> <span class="s2">&quot;ks&quot;</span><span class="p">,</span> <span class="s2">&quot;ky&quot;</span><span class="p">,</span> <span class="s2">&quot;la&quot;</span><span class="p">,</span> <span class="s2">&quot;me&quot;</span><span class="p">,</span> <span class="s2">&quot;md&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ma&quot;</span><span class="p">,</span> <span class="s2">&quot;mi&quot;</span><span class="p">,</span> <span class="s2">&quot;mn&quot;</span><span class="p">,</span> <span class="s2">&quot;ms&quot;</span><span class="p">,</span> <span class="s2">&quot;mo&quot;</span><span class="p">,</span> <span class="s2">&quot;mt&quot;</span><span class="p">,</span> <span class="s2">&quot;ne&quot;</span><span class="p">,</span> <span class="s2">&quot;nv&quot;</span><span class="p">,</span> <span class="s2">&quot;nh&quot;</span><span class="p">,</span> <span class="s2">&quot;nj&quot;</span><span class="p">,</span>
            <span class="s2">&quot;nm&quot;</span><span class="p">,</span> <span class="s2">&quot;ny&quot;</span><span class="p">,</span> <span class="s2">&quot;nc&quot;</span><span class="p">,</span> <span class="s2">&quot;nd&quot;</span><span class="p">,</span> <span class="s2">&quot;oh&quot;</span><span class="p">,</span> <span class="s2">&quot;ok&quot;</span><span class="p">,</span> <span class="s2">&quot;or&quot;</span><span class="p">,</span> <span class="s2">&quot;pa&quot;</span><span class="p">,</span> <span class="s2">&quot;ri&quot;</span><span class="p">,</span> <span class="s2">&quot;sc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sd&quot;</span><span class="p">,</span> <span class="s2">&quot;tn&quot;</span><span class="p">,</span> <span class="s2">&quot;tx&quot;</span><span class="p">,</span> <span class="s2">&quot;ut&quot;</span><span class="p">,</span> <span class="s2">&quot;vt&quot;</span><span class="p">,</span> <span class="s2">&quot;va&quot;</span><span class="p">,</span> <span class="s2">&quot;wa&quot;</span><span class="p">,</span> <span class="s2">&quot;wv&quot;</span><span class="p">,</span> <span class="s2">&quot;wi&quot;</span><span class="p">,</span> <span class="s2">&quot;wy&quot;</span><span class="p">,</span> <span class="s2">&quot;other&quot;</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_states</span><span class="p">:</span>
            <span class="n">state</span> <span class="o">=</span> <span class="s2">&quot;other&quot;</span>

        <span class="n">political_affiliation</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">political_affiliation</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">political_affiliation</span> <span class="k">else</span> <span class="s2">&quot;other&quot;</span>
        <span class="n">valid_political</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;democrat&quot;</span><span class="p">,</span> <span class="s2">&quot;republican&quot;</span><span class="p">,</span> <span class="s2">&quot;independent&quot;</span><span class="p">,</span> <span class="s2">&quot;libertarian&quot;</span><span class="p">,</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span>
            <span class="s2">&quot;conservative&quot;</span><span class="p">,</span> <span class="s2">&quot;progressive&quot;</span><span class="p">,</span> <span class="s2">&quot;moderate&quot;</span><span class="p">,</span> <span class="s2">&quot;socialist&quot;</span><span class="p">,</span> <span class="s2">&quot;communist&quot;</span><span class="p">,</span> <span class="s2">&quot;other&quot;</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">political_affiliation</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_political</span><span class="p">:</span>
            <span class="n">political_affiliation</span> <span class="o">=</span> <span class="s2">&quot;other&quot;</span>

        <span class="c1"># Get or create the vote record for the bill.</span>
        <span class="n">vote_record</span> <span class="o">=</span> <span class="n">Vote</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">bill_id</span><span class="o">=</span><span class="n">bill_id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">vote_record</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">vote_status</span> <span class="o">!=</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
                <span class="n">vote_record</span> <span class="o">=</span> <span class="n">Vote</span><span class="p">(</span><span class="n">bill_id</span><span class="o">=</span><span class="n">bill_id</span><span class="p">,</span> <span class="n">demographics</span><span class="o">=</span><span class="n">default_demographics</span><span class="p">())</span>
                <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">vote_record</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;No existing vote to remove for this bill.&quot;</span><span class="p">}),</span> <span class="mi">400</span>

        <span class="n">previous_vote</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">voted_bills</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">bill_id</span><span class="p">))</span>

        <span class="c1"># CASE 1: User has not voted yet.</span>
        <span class="k">if</span> <span class="n">previous_vote</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">vote_status</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;You haven&#39;t voted on this bill yet.&quot;</span><span class="p">}),</span> <span class="mi">400</span>

            <span class="c1"># Increment demographics for the new vote.</span>
            <span class="n">demo</span> <span class="o">=</span> <span class="n">vote_record</span><span class="o">.</span><span class="n">demographics</span><span class="p">[</span><span class="n">vote_status</span><span class="p">]</span>
            <span class="n">demo</span><span class="p">[</span><span class="s2">&quot;age_distribution&quot;</span><span class="p">][</span><span class="n">age_category</span><span class="p">]</span> <span class="o">=</span> <span class="n">demo</span><span class="p">[</span><span class="s2">&quot;age_distribution&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">age_category</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">demo</span><span class="p">[</span><span class="s2">&quot;gender_distribution&quot;</span><span class="p">][</span><span class="n">gender</span><span class="p">]</span> <span class="o">=</span> <span class="n">demo</span><span class="p">[</span><span class="s2">&quot;gender_distribution&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">gender</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">demo</span><span class="p">[</span><span class="s2">&quot;ethnicity_distribution&quot;</span><span class="p">][</span><span class="n">ethnicity</span><span class="p">]</span> <span class="o">=</span> <span class="n">demo</span><span class="p">[</span><span class="s2">&quot;ethnicity_distribution&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ethnicity</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">demo</span><span class="p">[</span><span class="s2">&quot;state_distribution&quot;</span><span class="p">][</span><span class="n">state</span><span class="p">]</span> <span class="o">=</span> <span class="n">demo</span><span class="p">[</span><span class="s2">&quot;state_distribution&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">demo</span><span class="p">[</span><span class="s2">&quot;political_affiliation_distribution&quot;</span><span class="p">][</span><span class="n">political_affiliation</span><span class="p">]</span> <span class="o">=</span> <span class="n">demo</span><span class="p">[</span><span class="s2">&quot;political_affiliation_distribution&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">political_affiliation</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">vote_record</span><span class="o">.</span><span class="n">demographics</span><span class="p">[</span><span class="n">vote_status</span><span class="p">]</span> <span class="o">=</span> <span class="n">demo</span>

        
            <span class="k">if</span> <span class="n">vote_status</span> <span class="o">==</span> <span class="s2">&quot;upvote&quot;</span><span class="p">:</span>
                <span class="n">bill</span><span class="o">.</span><span class="n">upvote_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">bill</span><span class="o">.</span><span class="n">vote_count</span> <span class="o">+=</span><span class="mi">1</span>
            <span class="k">if</span> <span class="n">vote_status</span> <span class="o">==</span> <span class="s2">&quot;downvote&quot;</span><span class="p">:</span>
                <span class="n">bill</span><span class="o">.</span><span class="n">downvote_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">bill</span><span class="o">.</span><span class="n">vote_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">user</span><span class="o">.</span><span class="n">voted_bills</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">bill_id</span><span class="p">)]</span> <span class="o">=</span> <span class="n">vote_status</span>

        <span class="c1"># CASE 2: User has already voted on this bill.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">vote_status</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
                <span class="c1"># Remove the vote: decrement demographics.</span>
                <span class="n">old_demo</span> <span class="o">=</span> <span class="n">vote_record</span><span class="o">.</span><span class="n">demographics</span><span class="p">[</span><span class="n">previous_vote</span><span class="p">]</span>
                <span class="n">old_demo</span><span class="p">[</span><span class="s2">&quot;age_distribution&quot;</span><span class="p">][</span><span class="n">age_category</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">old_demo</span><span class="p">[</span><span class="s2">&quot;age_distribution&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">age_category</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">old_demo</span><span class="p">[</span><span class="s2">&quot;gender_distribution&quot;</span><span class="p">][</span><span class="n">gender</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">old_demo</span><span class="p">[</span><span class="s2">&quot;gender_distribution&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">gender</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">old_demo</span><span class="p">[</span><span class="s2">&quot;ethnicity_distribution&quot;</span><span class="p">][</span><span class="n">ethnicity</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">old_demo</span><span class="p">[</span><span class="s2">&quot;ethnicity_distribution&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ethnicity</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">old_demo</span><span class="p">[</span><span class="s2">&quot;state_distribution&quot;</span><span class="p">][</span><span class="n">state</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">old_demo</span><span class="p">[</span><span class="s2">&quot;state_distribution&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">old_demo</span><span class="p">[</span><span class="s2">&quot;political_affiliation_distribution&quot;</span><span class="p">][</span><span class="n">political_affiliation</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">old_demo</span><span class="p">[</span><span class="s2">&quot;political_affiliation_distribution&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">political_affiliation</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">vote_record</span><span class="o">.</span><span class="n">demographics</span><span class="p">[</span><span class="n">previous_vote</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_demo</span>

                <span class="n">bill</span><span class="o">.</span><span class="n">vote_count</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">bill</span><span class="o">.</span><span class="n">vote_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">previous_vote</span> <span class="o">==</span> <span class="s2">&quot;upvote&quot;</span><span class="p">:</span>
                    <span class="n">bill</span><span class="o">.</span><span class="n">upvote_count</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">bill</span><span class="o">.</span><span class="n">upvote_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">previous_vote</span> <span class="o">==</span> <span class="s2">&quot;downvote&quot;</span><span class="p">:</span>
                    <span class="n">bill</span><span class="o">.</span><span class="n">downvote_count</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">bill</span><span class="o">.</span><span class="n">downvote_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">bill_id</span><span class="p">)</span> <span class="ow">in</span> <span class="n">user</span><span class="o">.</span><span class="n">voted_bills</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">user</span><span class="o">.</span><span class="n">voted_bills</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">bill_id</span><span class="p">)]</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># If the vote is the same as before, nothing needs to change.</span>
                <span class="k">if</span> <span class="n">previous_vote</span> <span class="o">==</span> <span class="n">vote_status</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Vote already recorded with the same status.&quot;</span><span class="p">}),</span> <span class="mi">200</span>

                <span class="c1"># Changing the vote: first remove the old vote&#39;s demographics.</span>
                <span class="n">old_demo</span> <span class="o">=</span> <span class="n">vote_record</span><span class="o">.</span><span class="n">demographics</span><span class="p">[</span><span class="n">previous_vote</span><span class="p">]</span>
                <span class="n">old_demo</span><span class="p">[</span><span class="s2">&quot;age_distribution&quot;</span><span class="p">][</span><span class="n">age_category</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">old_demo</span><span class="p">[</span><span class="s2">&quot;age_distribution&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">age_category</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">old_demo</span><span class="p">[</span><span class="s2">&quot;gender_distribution&quot;</span><span class="p">][</span><span class="n">gender</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">old_demo</span><span class="p">[</span><span class="s2">&quot;gender_distribution&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">gender</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">old_demo</span><span class="p">[</span><span class="s2">&quot;ethnicity_distribution&quot;</span><span class="p">][</span><span class="n">ethnicity</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">old_demo</span><span class="p">[</span><span class="s2">&quot;ethnicity_distribution&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ethnicity</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">old_demo</span><span class="p">[</span><span class="s2">&quot;state_distribution&quot;</span><span class="p">][</span><span class="n">state</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">old_demo</span><span class="p">[</span><span class="s2">&quot;state_distribution&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">old_demo</span><span class="p">[</span><span class="s2">&quot;political_affiliation_distribution&quot;</span><span class="p">][</span><span class="n">political_affiliation</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">old_demo</span><span class="p">[</span><span class="s2">&quot;political_affiliation_distribution&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">political_affiliation</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">vote_record</span><span class="o">.</span><span class="n">demographics</span><span class="p">[</span><span class="n">previous_vote</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_demo</span>

                <span class="c1"># Then add the new vote&#39;s demographics.</span>
                <span class="n">new_demo</span> <span class="o">=</span> <span class="n">vote_record</span><span class="o">.</span><span class="n">demographics</span><span class="p">[</span><span class="n">vote_status</span><span class="p">]</span>
                <span class="n">new_demo</span><span class="p">[</span><span class="s2">&quot;age_distribution&quot;</span><span class="p">][</span><span class="n">age_category</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_demo</span><span class="p">[</span><span class="s2">&quot;age_distribution&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">age_category</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">new_demo</span><span class="p">[</span><span class="s2">&quot;gender_distribution&quot;</span><span class="p">][</span><span class="n">gender</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_demo</span><span class="p">[</span><span class="s2">&quot;gender_distribution&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">gender</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">new_demo</span><span class="p">[</span><span class="s2">&quot;ethnicity_distribution&quot;</span><span class="p">][</span><span class="n">ethnicity</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_demo</span><span class="p">[</span><span class="s2">&quot;ethnicity_distribution&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ethnicity</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">new_demo</span><span class="p">[</span><span class="s2">&quot;state_distribution&quot;</span><span class="p">][</span><span class="n">state</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_demo</span><span class="p">[</span><span class="s2">&quot;state_distribution&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">new_demo</span><span class="p">[</span><span class="s2">&quot;political_affiliation_distribution&quot;</span><span class="p">][</span><span class="n">political_affiliation</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_demo</span><span class="p">[</span><span class="s2">&quot;political_affiliation_distribution&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">political_affiliation</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">vote_record</span><span class="o">.</span><span class="n">demographics</span><span class="p">[</span><span class="n">vote_status</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_demo</span>

                <span class="k">if</span> <span class="n">previous_vote</span> <span class="o">==</span> <span class="s2">&quot;upvote&quot;</span><span class="p">:</span>
                    <span class="n">bill</span><span class="o">.</span><span class="n">upvote_count</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">bill</span><span class="o">.</span><span class="n">upvote_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">bill</span><span class="o">.</span><span class="n">downvote_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="n">previous_vote</span> <span class="o">==</span> <span class="s2">&quot;downvote&quot;</span><span class="p">:</span>
                    <span class="n">bill</span><span class="o">.</span><span class="n">downvote_count</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">bill</span><span class="o">.</span><span class="n">downvote_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">bill</span><span class="o">.</span><span class="n">upvote_count</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># Update the user&#39;s vote to the new status.</span>
                <span class="n">user</span><span class="o">.</span><span class="n">voted_bills</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">bill_id</span><span class="p">)]</span> <span class="o">=</span> <span class="n">vote_status</span>

        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Vote processed successfully&quot;</span><span class="p">,</span>
            <span class="s2">&quot;vote&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;bill_id&quot;</span><span class="p">:</span> <span class="n">bill_id</span><span class="p">,</span>
                <span class="s2">&quot;vote_status&quot;</span><span class="p">:</span> <span class="n">vote_status</span><span class="p">,</span>
                <span class="s2">&quot;demographics&quot;</span><span class="p">:</span> <span class="n">vote_record</span><span class="o">.</span><span class="n">demographics</span>
            <span class="p">},</span>
            <span class="s2">&quot;bill&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">bill</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="s2">&quot;vote_count&quot;</span><span class="p">:</span> <span class="n">bill</span><span class="o">.</span><span class="n">vote_count</span><span class="p">,</span>
                <span class="s2">&quot;upvote_count&quot;</span><span class="p">:</span> <span class="n">bill</span><span class="o">.</span><span class="n">upvote_count</span><span class="p">,</span>
                <span class="s2">&quot;downvote_count&quot;</span><span class="p">:</span> <span class="n">bill</span><span class="o">.</span><span class="n">downvote_count</span>
            <span class="p">}</span>
        <span class="p">}),</span> <span class="mi">200</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;An error occurred: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}),</span> <span class="mi">500</span></div>



<div class="viewcode-block" id="get_bill_demographics">
<a class="viewcode-back" href="../../backend.html#backend.app.get_bill_demographics">[docs]</a>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/api/bills/&lt;int:bill_id&gt;/demographics&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_bill_demographics</span><span class="p">(</span><span class="n">bill_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Endpoint to retrieve demographic information for votes on a given bill.</span>
<span class="sd">    Returns the demographics data from the Vote record associated with the bill,</span>
<span class="sd">    or the default demographics if no votes have been recorded yet.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">bill</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Bill</span><span class="p">,</span> <span class="n">bill_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">bill</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Bill not found.&quot;</span><span class="p">}),</span> <span class="mi">404</span>

        <span class="n">vote_record</span> <span class="o">=</span> <span class="n">Vote</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">bill_id</span><span class="o">=</span><span class="n">bill_id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">vote_record</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">demographics</span> <span class="o">=</span> <span class="n">default_demographics</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">demographics</span> <span class="o">=</span> <span class="n">vote_record</span><span class="o">.</span><span class="n">demographics</span>

        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
            <span class="s2">&quot;bill_id&quot;</span><span class="p">:</span> <span class="n">bill_id</span><span class="p">,</span>
            <span class="s2">&quot;demographics&quot;</span><span class="p">:</span> <span class="n">demographics</span>
        <span class="p">}),</span> <span class="mi">200</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;An error occurred: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}),</span> <span class="mi">500</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">8080</span><span class="p">)</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Policy Pal</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">backend</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2025, Alexander Edwards, Jacob Ryan, Tyler Cho, Akash Banerjee, Raphael Luis Santos,Armeen Seyed Makki.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>